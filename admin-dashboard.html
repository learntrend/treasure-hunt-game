<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt Game - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #1a1a2e;
            margin-bottom: 30px;
            text-align: center;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #1a1a2e;
            margin-bottom: 20px;
            border-bottom: 2px solid #e94560;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #d1344f;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #1a1a2e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .timestamp {
            font-size: 12px;
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-solo {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-group {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-pending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-confirmed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-completed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1a1a2e;
        }

        .btn-close {
            background: rgba(233, 69, 96, 0.1);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2rem;
            cursor: pointer;
            color: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        .modal-body .form-group {
            margin-bottom: 15px;
        }

        .modal-body .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .export-btn {
            background: #4caf50;
        }

        .export-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Treasure Hunt Game - Admin Dashboard</h1>

        <!-- Active Game Sessions -->
        <div class="section">
            <h2>üìä Active Game Sessions</h2>
            <div class="controls">
                <button onclick="loadActiveSessions()">üîÑ Refresh Active Sessions</button>
                <button onclick="exportToCSV('active')" class="export-btn">üì• Export to CSV</button>
            </div>
            <div id="active-stats" class="stats"></div>
            <div id="active-sessions-container">
                <div class="loading">Loading active sessions...</div>
            </div>
        </div>

        <!-- Bookings -->
        <div class="section">
            <h2>üìÖ Bookings</h2>
            <div class="controls">
                <button onclick="loadBookings()">üîÑ Refresh Bookings</button>
                <button onclick="exportBookingsToCSV()" class="export-btn">üì• Export to CSV</button>
            </div>
            <div id="bookings-stats" class="stats"></div>
            
            <!-- Upcoming Bookings -->
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color);">Upcoming Bookings</h3>
            <div id="upcoming-bookings-container">
                <div class="loading">Loading upcoming bookings...</div>
            </div>
            
            <!-- Completed Bookings -->
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color);">Completed Bookings</h3>
            <div id="completed-bookings-container">
                <div class="loading">Loading completed bookings...</div>
            </div>
        </div>

        <!-- Completed Games -->
        <div class="section">
            <h2>üèÜ Completed Games</h2>
            <div class="controls">
                <button onclick="loadCompletedGames()">üîÑ Refresh Completed Games</button>
                <button onclick="loadLeaderboard('solo')">‚≠ê Solo Leaderboard</button>
                <button onclick="loadLeaderboard('group')">üë• Group Leaderboard</button>
                <button onclick="exportToCSV('completed')" class="export-btn">üì• Export to CSV</button>
            </div>
            <div id="completed-stats" class="stats"></div>
            <div id="completed-games-container">
                <div class="loading">Loading completed games...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="database.js"></script>
    
    <script>
        // Use localDb to avoid conflict with database.js which also declares 'db'
        let localDb = null;
        let activeSessionsData = [];
        let completedGamesData = [];
        let bookingsData = [];

        // Initialize Firebase
        function initializeFirebase() {
            if (typeof firebase === 'undefined' || typeof firebaseConfig === 'undefined') {
                alert('Firebase not configured. Please check firebase-config.js');
                return false;
            }

            try {
                firebase.initializeApp(firebaseConfig);
                localDb = firebase.firestore();
                return true;
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                alert('Error initializing Firebase. Check console for details.');
                return false;
            }
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            if (timestamp.toDate) {
                return timestamp.toDate().toLocaleString();
            }
            return new Date(timestamp).toLocaleString();
        }

        // Format time (seconds to MM:SS)
        function formatTime(seconds) {
            if (!seconds) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Load active game sessions
        async function loadActiveSessions() {
            if (!localDb) {
                if (!initializeFirebase()) return;
            }

            const container = document.getElementById('active-sessions-container');
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const snapshot = await localDb.collection('gameSessions')
                    .orderBy('updatedAt', 'desc')
                    .get();

                activeSessionsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update stats
                updateActiveStats(activeSessionsData);

                // Display table
                displayActiveSessions(activeSessionsData);
            } catch (error) {
                console.error('Error loading active sessions:', error);
                container.innerHTML = `<div class="empty-state">Error loading data: ${error.message}</div>`;
            }
        }

        // Display active sessions table
        function displayActiveSessions(data) {
            const container = document.getElementById('active-sessions-container');

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No active game sessions</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Player Type</th>
                            <th>Player/Group Name</th>
                            <th>Group Members</th>
                            <th>Current Location</th>
                            <th>Score</th>
                            <th>Time</th>
                            <th>Text Hints Used</th>
                            <th>Map Hints Used</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(session => {
                const locationNum = session.currentLocationIndex || 0;
                const locationText = locationNum === 0 ? 'Starting Point' : `Location ${locationNum}`;
                const status = session.isTimerRunning 
                    ? (session.isTimerPaused ? '‚è∏Ô∏è Paused' : '‚ñ∂Ô∏è Running') 
                    : '‚èπÔ∏è Stopped';
                const playerType = session.playerType || 'solo';
                const members = session.groupMembers && session.groupMembers.length > 0 
                    ? session.groupMembers.join(', ') 
                    : '-';

                // Format hints used
                const textHints = session.hintsUsed?.textHints || [];
                const mapHints = session.hintsUsed?.mapHints || [];
                
                const formatHints = (hintArray) => {
                    if (!hintArray || hintArray.length === 0) return '<span style="color: #999;">None</span>';
                    const sortedHints = [...hintArray].sort((a, b) => a - b);
                    return sortedHints.map(locId => {
                        const locNum = locId === 0 ? 'Starting Point' : `Location ${locId}`;
                        return `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 11px;">${locNum}</span>`;
                    }).join('');
                };

                const textHintsDisplay = formatHints(textHints);
                const mapHintsDisplay = formatHints(mapHints);

                html += `
                    <tr>
                        <td>${session.sessionId || session.id}</td>
                        <td><span class="badge badge-${playerType}">${playerType.toUpperCase()}</span></td>
                        <td>${session.playerName || 'N/A'}</td>
                        <td>${members}</td>
                        <td>${locationText}</td>
                        <td>${session.score || 0} ‚≠ê</td>
                        <td>${formatTime(session.elapsedTime)}</td>
                        <td style="font-size: 12px;">${textHintsDisplay}</td>
                        <td style="font-size: 12px;">${mapHintsDisplay}</td>
                        <td>${status}</td>
                        <td class="timestamp">${formatTimestamp(session.updatedAt)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update active sessions stats
        function updateActiveStats(data) {
            const statsContainer = document.getElementById('active-stats');
            const soloCount = data.filter(s => s.playerType === 'solo').length;
            const groupCount = data.filter(s => s.playerType === 'group').length;
            const totalScore = data.reduce((sum, s) => sum + (s.score || 0), 0);
            const totalTextHints = data.reduce((sum, s) => sum + ((s.hintsUsed?.textHints || []).length), 0);
            const totalMapHints = data.reduce((sum, s) => sum + ((s.hintsUsed?.mapHints || []).length), 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Total Active Sessions</h3>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-card">
                    <h3>Solo Players</h3>
                    <div class="value">${soloCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Groups</h3>
                    <div class="value">${groupCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Score</h3>
                    <div class="value">${totalScore}</div>
                </div>
                <div class="stat-card">
                    <h3>Text Hints Used</h3>
                    <div class="value">${totalTextHints}</div>
                </div>
                <div class="stat-card">
                    <h3>Map Hints Used</h3>
                    <div class="value">${totalMapHints}</div>
                </div>
            `;
        }

        // Load completed games
        async function loadCompletedGames() {
            if (!localDb) {
                if (!initializeFirebase()) return;
            }

            const container = document.getElementById('completed-games-container');
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const snapshot = await localDb.collection('completedGames')
                    .orderBy('completedAt', 'desc')
                    .limit(100)
                    .get();

                completedGamesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update stats
                updateCompletedStats(completedGamesData);

                // Display table
                displayCompletedGames(completedGamesData);
            } catch (error) {
                console.error('Error loading completed games:', error);
                container.innerHTML = `<div class="empty-state">Error loading data: ${error.message}</div>`;
            }
        }

        // Display completed games table
        function displayCompletedGames(data) {
            const container = document.getElementById('completed-games-container');

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No completed games yet</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Player Type</th>
                            <th>Player/Group Name</th>
                            <th>Group Members</th>
                            <th>Final Score</th>
                            <th>Final Time</th>
                            <th>Calculated Score</th>
                            <th>Locations Completed</th>
                            <th>Text Hints Used</th>
                            <th>Map Hints Used</th>
                            <th>Completed At</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((game, index) => {
                const playerType = game.playerType || 'solo';
                const members = game.groupMembers && game.groupMembers.length > 0 
                    ? game.groupMembers.join(', ') 
                    : '-';
                const locationsCount = game.completedLocations ? game.completedLocations.length : 0;

                // Format hints used
                const textHints = game.hintsUsed?.textHints || [];
                const mapHints = game.hintsUsed?.mapHints || [];
                
                const formatHints = (hintArray) => {
                    if (!hintArray || hintArray.length === 0) return '<span style="color: #999;">None</span>';
                    const sortedHints = [...hintArray].sort((a, b) => a - b);
                    return sortedHints.map(locId => {
                        const locNum = locId === 0 ? 'Starting Point' : `Location ${locId}`;
                        return `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 11px;">${locNum}</span>`;
                    }).join('');
                };

                const textHintsDisplay = formatHints(textHints);
                const mapHintsDisplay = formatHints(mapHints);

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="badge badge-${playerType}">${playerType.toUpperCase()}</span></td>
                        <td>${game.playerName || 'N/A'}</td>
                        <td>${members}</td>
                        <td><strong>${game.finalScore || 0} ‚≠ê</strong></td>
                        <td>${formatTime(game.finalTime)}</td>
                        <td><strong>${game.calculatedScore || 0}</strong></td>
                        <td>${locationsCount}/10</td>
                        <td style="font-size: 12px;">${textHintsDisplay}</td>
                        <td style="font-size: 12px;">${mapHintsDisplay}</td>
                        <td class="timestamp">${formatTimestamp(game.completedAt)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update completed games stats
        function updateCompletedStats(data) {
            const statsContainer = document.getElementById('completed-stats');
            const soloCount = data.filter(g => g.playerType === 'solo').length;
            const groupCount = data.filter(g => g.playerType === 'group').length;
            const avgScore = data.length > 0 
                ? Math.round(data.reduce((sum, g) => sum + (g.finalScore || 0), 0) / data.length)
                : 0;
            const avgTime = data.length > 0
                ? Math.round(data.reduce((sum, g) => sum + (g.finalTime || 0), 0) / data.length)
                : 0;
            const totalTextHints = data.reduce((sum, g) => sum + ((g.hintsUsed?.textHints || []).length), 0);
            const totalMapHints = data.reduce((sum, g) => sum + ((g.hintsUsed?.mapHints || []).length), 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Total Completed</h3>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-card">
                    <h3>Solo Completions</h3>
                    <div class="value">${soloCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Group Completions</h3>
                    <div class="value">${groupCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Score</h3>
                    <div class="value">${avgScore} ‚≠ê</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Time</h3>
                    <div class="value">${formatTime(avgTime)}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Text Hints</h3>
                    <div class="value">${totalTextHints}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Map Hints</h3>
                    <div class="value">${totalMapHints}</div>
                </div>
            `;
        }

        // Load leaderboard
        async function loadLeaderboard(type) {
            if (!localDb) {
                if (!initializeFirebase()) return;
            }

            const container = document.getElementById('completed-games-container');
            container.innerHTML = '<div class="loading">Loading leaderboard...</div>';

            try {
                const snapshot = await localDb.collection('completedGames')
                    .where('playerType', '==', type)
                    .orderBy('calculatedScore', 'desc')
                    .limit(50)
                    .get();

                completedGamesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateCompletedStats(completedGamesData);
                displayCompletedGames(completedGamesData);
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                
                // Check if it's an index error
                if (error.message && error.message.includes('index')) {
                    // Extract the index creation URL if present
                    const indexUrlMatch = error.message.match(/https:\/\/[^\s]+/);
                    const indexUrl = indexUrlMatch ? indexUrlMatch[0] : null;
                    
                    let errorHtml = `
                        <div class="empty-state">
                            <h3 style="color: #e94560; margin-bottom: 15px;">‚ö†Ô∏è Index Required</h3>
                            <p style="margin-bottom: 15px;">Firestore needs to create an index for this query.</p>
                    `;
                    
                    if (indexUrl) {
                        errorHtml += `
                            <p style="margin-bottom: 20px;">
                                <a href="${indexUrl}" target="_blank" style="color: #667eea; text-decoration: underline;">
                                    Click here to create the index automatically
                                </a>
                            </p>
                        `;
                    }
                    
                    errorHtml += `
                            <p style="font-size: 12px; color: #666;">
                                After creating the index, wait 1-2 minutes for it to build, then refresh this page.
                            </p>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                Or see FIREBASE-SETUP.md Step 7 for manual index creation.
                            </p>
                        </div>
                    `;
                    
                    container.innerHTML = errorHtml;
                } else {
                    container.innerHTML = `<div class="empty-state">Error loading leaderboard: ${error.message}</div>`;
                }
            }
        }

        // Export to CSV
        function exportToCSV(type) {
            let data, filename;
            
            if (type === 'active') {
                data = activeSessionsData;
                filename = 'active-sessions.csv';
            } else {
                data = completedGamesData;
                filename = 'completed-games.csv';
            }

            if (data.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = '';
            
            if (type === 'active') {
                csv = 'Session ID,Player Type,Player Name,Group Members,Current Location,Score,Time,Text Hints Used,Map Hints Used,Status,Last Updated\n';
                data.forEach(session => {
                    const locationNum = session.currentLocationIndex || 0;
                    const locationText = locationNum === 0 ? 'Starting Point' : `Location ${locationNum}`;
                    const members = session.groupMembers ? session.groupMembers.join('; ') : '';
                    const status = session.isTimerRunning 
                        ? (session.isTimerPaused ? 'Paused' : 'Running') 
                        : 'Stopped';
                    const textHints = session.hintsUsed?.textHints || [];
                    const mapHints = session.hintsUsed?.mapHints || [];
                    const textHintsStr = textHints.length > 0 
                        ? textHints.sort((a,b) => a-b).map(id => id === 0 ? 'Starting Point' : `Location ${id}`).join('; ')
                        : 'None';
                    const mapHintsStr = mapHints.length > 0 
                        ? mapHints.sort((a,b) => a-b).map(id => id === 0 ? 'Starting Point' : `Location ${id}`).join('; ')
                        : 'None';
                    
                    csv += `"${session.sessionId || session.id}","${session.playerType || 'solo'}","${session.playerName || ''}","${members}","${locationText}","${session.score || 0}","${formatTime(session.elapsedTime)}","${textHintsStr}","${mapHintsStr}","${status}","${formatTimestamp(session.updatedAt)}"\n`;
                });
            } else {
                csv = '#,Player Type,Player Name,Group Members,Final Score,Final Time,Calculated Score,Locations Completed,Text Hints Used,Map Hints Used,Completed At\n';
                data.forEach((game, index) => {
                    const members = game.groupMembers ? game.groupMembers.join('; ') : '';
                    const locationsCount = game.completedLocations ? game.completedLocations.length : 0;
                    const textHints = game.hintsUsed?.textHints || [];
                    const mapHints = game.hintsUsed?.mapHints || [];
                    const textHintsStr = textHints.length > 0 
                        ? textHints.sort((a,b) => a-b).map(id => id === 0 ? 'Starting Point' : `Location ${id}`).join('; ')
                        : 'None';
                    const mapHintsStr = mapHints.length > 0 
                        ? mapHints.sort((a,b) => a-b).map(id => id === 0 ? 'Starting Point' : `Location ${id}`).join('; ')
                        : 'None';
                    
                    csv += `${index + 1},"${game.playerType || 'solo'}","${game.playerName || ''}","${members}","${game.finalScore || 0}","${formatTime(game.finalTime)}","${game.calculatedScore || 0}","${locationsCount}/10","${textHintsStr}","${mapHintsStr}","${formatTimestamp(game.completedAt)}"\n`;
                });
            }

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Load bookings from Firebase
        async function loadBookings() {
            if (!localDb) {
                if (!initializeFirebase()) return;
            }

            const upcomingContainer = document.getElementById('upcoming-bookings-container');
            const completedContainer = document.getElementById('completed-bookings-container');
            
            if (!upcomingContainer || !completedContainer) return;
            
            upcomingContainer.innerHTML = '<div class="loading">Loading...</div>';
            completedContainer.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const snapshot = await localDb.collection('bookings')
                    .orderBy('date', 'asc')
                    .orderBy('time', 'asc')
                    .get();

                bookingsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Separate upcoming and completed
                const now = new Date();
                const upcoming = [];
                const completed = [];

                bookingsData.forEach(booking => {
                    if (!booking.date || !booking.time) {
                        completed.push(booking);
                        return;
                    }
                    
                    const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
                    if (bookingDateTime >= now && booking.status !== 'completed' && booking.status !== 'cancelled') {
                        upcoming.push(booking);
                    } else {
                        completed.push(booking);
                    }
                });

                // Update stats
                updateBookingsStats(upcoming.length, completed.length);

                // Display bookings
                displayUpcomingBookings(upcoming);
                displayCompletedBookings(completed);
            } catch (error) {
                console.error('Error loading bookings:', error);
                if (upcomingContainer) {
                    upcomingContainer.innerHTML = `<div class="empty-state">Error loading bookings: ${error.message}</div>`;
                }
                if (completedContainer) {
                    completedContainer.innerHTML = `<div class="empty-state">Error loading bookings: ${error.message}</div>`;
                }
            }
        }

        // Update bookings statistics
        function updateBookingsStats(upcomingCount, completedCount) {
            const statsContainer = document.getElementById('bookings-stats');
            if (!statsContainer) return;
            
            const pendingCount = bookingsData.filter(b => b.status === 'pending').length;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Total Bookings</h3>
                    <div class="value">${bookingsData.length}</div>
                </div>
                <div class="stat-card">
                    <h3>Upcoming</h3>
                    <div class="value">${upcomingCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="value">${completedCount}</div>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <div class="value">${pendingCount}</div>
                </div>
            `;
        }

        // Display upcoming bookings
        function displayUpcomingBookings(bookings) {
            const container = document.getElementById('upcoming-bookings-container');
            if (!container) return;

            if (bookings.length === 0) {
                container.innerHTML = '<div class="empty-state">No upcoming bookings</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Players</th>
                            <th>Payment</th>
                            <th>Personal Message</th>
                            <th>Status <span style="font-size: 0.8rem; font-weight: normal; color: #666;" title="Pending: Awaiting confirmation | Confirmed: Booking confirmed | Completed: Game finished | Cancelled: Booking cancelled">‚ÑπÔ∏è</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bookings.forEach((booking, index) => {
                const statusText = booking.status || 'pending';
                const statusTooltip = {
                    'pending': 'Awaiting confirmation',
                    'confirmed': 'Booking confirmed',
                    'completed': 'Game finished',
                    'cancelled': 'Booking cancelled'
                };
                const personalMessage = booking.personalMessage || '-';
                const messagePreview = personalMessage.length > 50 
                    ? personalMessage.substring(0, 50) + '...' 
                    : personalMessage;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${booking.name || '-'}</td>
                        <td style="font-size: 0.9rem;">${booking.email || '-'}</td>
                        <td>${booking.phone || '-'}</td>
                        <td>${formatBookingDate(booking.date)}</td>
                        <td>${booking.time || '-'}</td>
                        <td>${booking.players || '-'}</td>
                        <td>${formatPaymentMethod(booking.paymentMethod)}</td>
                        <td style="max-width: 200px; font-size: 0.85rem;" title="${personalMessage !== '-' ? personalMessage.replace(/"/g, '&quot;') : ''}">${messagePreview}</td>
                        <td>
                            <span class="badge badge-${statusText}" title="${statusTooltip[statusText] || 'Unknown status'}">
                                ${statusText.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <button onclick="editBooking('${booking.id}')" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">Edit</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Display completed bookings
        function displayCompletedBookings(bookings) {
            const container = document.getElementById('completed-bookings-container');
            if (!container) return;

            if (bookings.length === 0) {
                container.innerHTML = '<div class="empty-state">No completed bookings</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Players</th>
                            <th>Personal Message</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bookings.forEach((booking, index) => {
                const statusText = booking.status || 'completed';
                const statusTooltip = {
                    'pending': 'Awaiting confirmation',
                    'confirmed': 'Booking confirmed',
                    'completed': 'Game finished',
                    'cancelled': 'Booking cancelled'
                };
                const personalMessage = booking.personalMessage || '-';
                const messagePreview = personalMessage.length > 50 
                    ? personalMessage.substring(0, 50) + '...' 
                    : personalMessage;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${booking.name || '-'}</td>
                        <td style="font-size: 0.9rem;">${booking.email || '-'}</td>
                        <td>${booking.phone || '-'}</td>
                        <td>${formatBookingDate(booking.date)}</td>
                        <td>${booking.time || '-'}</td>
                        <td>${booking.players || '-'}</td>
                        <td style="max-width: 200px; font-size: 0.85rem;" title="${personalMessage !== '-' ? personalMessage.replace(/"/g, '&quot;') : ''}">${messagePreview}</td>
                        <td>
                            <span class="badge badge-${statusText}" title="${statusTooltip[statusText] || 'Unknown status'}">
                                ${statusText.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <button onclick="editBooking('${booking.id}')" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; margin-right: 5px;">Edit</button>
                            <button onclick="generateGameLink('${booking.id}')" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;" title="Generate/Copy Game Link">üîó Link</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Format booking date
        function formatBookingDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // Format payment method
        function formatPaymentMethod(method) {
            const map = {
                'card': 'üí≥ Card',
                'paypal': 'PayPal',
                'bank': 'üè¶ Bank'
            };
            return map[method] || method || '-';
        }

        // Edit booking
        function editBooking(bookingId) {
            const booking = bookingsData.find(b => b.id === bookingId);
            if (!booking) {
                alert('Booking not found');
                return;
            }

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Booking</h3>
                        <button onclick="this.closest('.modal').remove()" class="btn-close">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="edit-name" value="${(booking.name || '').replace(/"/g, '&quot;')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="edit-email" value="${(booking.email || '').replace(/"/g, '&quot;')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group">
                            <label>Phone:</label>
                            <input type="tel" id="edit-phone" value="${(booking.phone || '').replace(/"/g, '&quot;')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="edit-date" value="${booking.date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group">
                            <label>Time:</label>
                            <input type="time" id="edit-time" value="${booking.time || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="edit-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button onclick="saveBookingEdit('${bookingId}')" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 1;">Save</button>
                            <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer; flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Save booking edit
        async function saveBookingEdit(bookingId) {
            if (!localDb) {
                alert('Database not available');
                return;
            }

            try {
                const updates = {
                    name: document.getElementById('edit-name').value.trim(),
                    email: document.getElementById('edit-email').value.trim(),
                    phone: document.getElementById('edit-phone').value.trim(),
                    date: document.getElementById('edit-date').value,
                    time: document.getElementById('edit-time').value,
                    status: document.getElementById('edit-status').value,
                    updatedAt: firebase.firestore.Timestamp.now()
                };

                await localDb.collection('bookings').doc(bookingId).update(updates);
                
                // Close modal
                const modal = document.querySelector('.modal');
                if (modal) modal.remove();
                
                // Reload bookings
                loadBookings();
                
                alert('Booking updated successfully!');
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Error updating booking: ' + error.message);
            }
        }

        // Generate/Copy game link for a booking
        async function generateGameLink(bookingId) {
            if (!localDb) {
                alert('Database not available');
                return;
            }

            try {
                // Get booking data
                const bookingDoc = await db.collection('bookings').doc(bookingId).get();
                if (!bookingDoc.exists) {
                    alert('Booking not found');
                    return;
                }

                const booking = bookingDoc.data();
                
                // Check if game session exists, create if not
                let gameSessionId = booking.gameSessionId;
                
                if (!gameSessionId && window.DatabaseService && window.DatabaseService.isInitialized()) {
                    // Create game session
                    gameSessionId = await window.DatabaseService.createGameSessionFromBooking(bookingId, booking);
                    
                    if (gameSessionId) {
                        // Update booking with game session info
                        await localDb.collection('bookings').doc(bookingId).update({
                            gameSessionId: gameSessionId,
                            updatedAt: firebase.firestore.Timestamp.now()
                        });
                    }
                }

                // Generate game link
                const baseUrl = window.location.origin + window.location.pathname.replace('admin-dashboard.html', 'index.html');
                const gameLink = `${baseUrl}?bookingId=${bookingId}`;

                // Copy to clipboard
                try {
                    await navigator.clipboard.writeText(gameLink);
                    alert(`Game link copied to clipboard!\n\n${gameLink}\n\nShare this link with the player. The game will be available 15 minutes before their booking time.`);
                } catch (err) {
                    // Fallback: show in prompt
                    prompt('Copy this game link:', gameLink);
                }

                // Update booking with game link if not already set
                if (!booking.gameLink) {
                    await localDb.collection('bookings').doc(bookingId).update({
                        gameLink: gameLink,
                        updatedAt: firebase.firestore.Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('Error generating game link:', error);
                alert('Error generating game link: ' + error.message);
            }
        }

        // Export bookings to CSV
        function exportBookingsToCSV() {
            if (bookingsData.length === 0) {
                alert('No bookings to export');
                return;
            }

            let csv = 'Name,Email,Phone,Date,Time,Players,Payment Method,Personal Message,Status,Referral,Special Requests,Emergency Contact,Submitted At\n';
            
            bookingsData.forEach(booking => {
                const name = (booking.name || '').replace(/"/g, '""');
                const email = (booking.email || '').replace(/"/g, '""');
                const phone = (booking.phone || '').replace(/"/g, '""');
                const personalMessage = (booking.personalMessage || '').replace(/"/g, '""');
                const specialRequests = (booking.specialRequests || '').replace(/"/g, '""');
                const emergencyContact = (booking.emergencyContact || '').replace(/"/g, '""');
                const submittedAt = booking.submittedAt || '';
                
                csv += `"${name}","${email}","${phone}","${booking.date || ''}","${booking.time || ''}","${booking.players || ''}","${booking.paymentMethod || ''}","${personalMessage}","${booking.status || ''}","${booking.referral || ''}","${specialRequests}","${emergencyContact}","${submittedAt}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bookings-data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            if (initializeFirebase()) {
                loadActiveSessions();
                loadCompletedGames();
                loadBookings();
            }
        });
    </script>
</body>
</html>
