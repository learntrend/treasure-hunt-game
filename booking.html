<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Adventure - Letter Left Behind</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .booking-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .booking-intro {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.8;
        }

        .booking-form {
            background: var(--card-bg);
            color: var(--text-dark);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow-light);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .form-group label .required {
            color: var(--accent-color);
            margin-left: 3px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .payment-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .payment-option:hover {
            border-color: var(--accent-color);
            background: rgba(233, 69, 96, 0.05);
        }

        .payment-option input[type="radio"] {
            display: none;
        }

        .payment-option.selected {
            border-color: var(--accent-color);
            background: rgba(233, 69, 96, 0.1);
        }

        .payment-option label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
        }

        .submit-section {
            margin-top: 30px;
            text-align: center;
        }

        .booking-success {
            display: none;
            text-align: center;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            color: var(--text-dark);
        }

        .booking-success.show {
            display: block;
        }

        .booking-success h2 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #1a1a2e;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .booking-success p {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.8;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .error-message {
            color: var(--accent-color);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .form-group.error .error-message {
            display: block;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--accent-color);
        }

        .form-errors {
            background: rgba(233, 69, 96, 0.1);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .form-errors ul {
            margin: 0;
            padding-left: 20px;
        }

        .form-errors li {
            margin: 5px 0;
            font-weight: 500;
        }

        .datetime-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Number input spinner visibility - show on mobile */
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }
        
        /* Show number input arrows on mobile */
        @media (max-width: 768px) {
            .datetime-inputs {
                grid-template-columns: 1fr;
            }
            
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: inner-spin-button;
                display: block;
                opacity: 1;
                height: 20px;
                width: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Support Links (Fixed) -->
    <div class="support-links-fixed">
        <a href="mailto:meghana.shettigar@gmail.com?subject=Issue with Letter Left Behind" class="support-email-link" title="Email Support">
            üìß Email Support
        </a>
        <a href="tel:+447435672248" class="support-phone-link" title="Call Support">
            üìû Call Support
        </a>
    </div>

    <div class="booking-container">
        <div class="booking-header">
            <div class="time-machine-icon" style="text-align: center; margin-bottom: 20px;">
                <a href="landing.html" style="text-decoration: none; display: inline-block;">
                    <img src="images/letter-left-behind-logo.png" alt="Letter Left Behind Logo" style="max-width: 300px; height: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                </a>
                <span style="display:none;">‚è∞</span>
            </div>
            <h1 class="game-title">Book Your Adventure</h1>
            <p class="game-subtitle">Letter Left Behind - Treasure Hunt</p>
            <p style="margin-top: 10px;">
                <a href="landing.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; font-size: 0.9rem;">‚Üê Back to Home</a>
            </p>
        </div>

        <div class="booking-intro">
            <p>Ready to embark on a time-traveling treasure hunt? Fill out the form below to book your adventure!</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.9;">All fields marked with <span style="color: var(--accent-color);">*</span> are required.</p>
        </div>

        <!-- Booking Form -->
        <form id="booking-form" class="booking-form">
            <!-- Contact Information -->
            <div class="form-section">
                <h3>üìß Contact Information</h3>
                
                <div class="form-group">
                    <label for="email">Your Email Address <span class="required">*</span></label>
                    <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                    <small>We'll send your booking confirmation and game link here</small>
                    <div class="error-message" id="email-error"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Full Name <span class="required">*</span></label>
                        <input type="text" id="name" name="name" placeholder="John Doe" required>
                        <div class="error-message" id="name-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="phone">Contact Number <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" placeholder="+44 123 456 7890" required>
                        <small>Include country code</small>
                        <div class="error-message" id="phone-error"></div>
                    </div>
                </div>
            </div>

            <!-- Game Details -->
            <div class="form-section">
                <h3>üéÆ Game Details</h3>
                
                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="date">Preferred Date <span class="required">*</span></label>
                        <input type="date" id="date" name="date" required>
                        <div class="error-message" id="date-error"></div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="time-hour" style="margin-bottom: 8px;">Preferred Time <span class="required">*</span></label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <select id="time-hour" name="time-hour" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif;">
                                    <option value="">Hour</option>
                                </select>
                            </div>
                            <div>
                                <select id="time-minute" name="time-minute" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif;">
                                    <option value="">Minute</option>
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                        <small style="margin-top: 5px; display: block;">These are the available slots in the UK time</small>
                        <input type="hidden" id="time" name="time" required>
                        <div class="error-message" id="time-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="players">Number of Players <span class="required">*</span></label>
                    <input type="number" id="players" name="players" min="1" max="50" placeholder="Enter number of players" required>
                    <small>Enter the total number of players (minimum 1)</small>
                    <div class="error-message" id="players-error"></div>
                </div>
            </div>

            <!-- Personal Message -->
            <div class="form-section">
                <h3>üíå Personal Message (Optional)</h3>
                
                <div class="form-group">
                    <label for="message-from">From</label>
                    <input type="text" id="message-from" name="message-from" placeholder="Enter your name or sender name">
                    <small>This name will appear in the final letter</small>
                </div>
                
                <div class="form-group">
                    <label for="personal-message">Message for Final Letter</label>
                    <textarea id="personal-message" name="personal-message" placeholder="* Write a special message that will be revealed at the end of the game.&#10;* This could be a message for your team, a special note, or anything you'd like to say...&#10;* Do not include 'Dear ---' as it will be automatically added."></textarea>
                    <small>Optional: This message will appear in the final letter when the game is completed.</small>
                    <div class="error-message" id="personal-message-error"></div>
                </div>
            </div>

            <!-- Payment -->
            <!-- <div class="form-section">
                <h3>üí≥ Payment</h3>
                
                <div class="form-group">
                    <label>Payment Method <span class="required">*</span></label>
                    <div class="payment-options">
                        <div class="payment-option" onclick="selectPayment('card')">
                            <input type="radio" id="payment-card" name="payment" value="card">
                            <label for="payment-card">üí≥ Card</label>
                        </div>
                        <div class="payment-option" onclick="selectPayment('paypal')">
                            <input type="radio" id="payment-paypal" name="payment" value="paypal">
                            <label for="payment-paypal">PayPal</label>
                        </div>
                        <div class="payment-option" onclick="selectPayment('bank')">
                            <input type="radio" id="payment-bank" name="payment" value="bank">
                            <label for="payment-bank">üè¶ Bank Transfer</label>
                        </div>
                    </div>
                    <small>Payment link will be sent via email after booking confirmation</small>
                    <div class="error-message" id="payment-error"></div>
                </div>
            </div>-->

            <!-- Additional Information -->
            <div class="form-section">
                <h3>‚ÑπÔ∏è Additional Information</h3>
                
                <div class="form-group">
                    <label for="referral">How did you find us? <span class="required">*</span></label>
                    <select id="referral" name="referral" required>
                        <option value="">Select...</option>
                        <option value="google">Google Search</option>
                        <option value="social-media">Social Media (Facebook, Instagram, etc.)</option>
                        <option value="friend">Friend/Family Recommendation</option>
                        <option value="website">Other Website</option>
                        <option value="advertisement">Advertisement</option>
                        <option value="event">Event/Festival</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="error-message" id="referral-error"></div>
                </div>

                <div class="form-group">
                    <label for="special-requests">Special Requests or Notes (Optional)</label>
                    <textarea id="special-requests" name="special-requests" placeholder="Any special requirements, accessibility needs, or notes for us..."></textarea>
                    <small>Optional: Let us know if you have any special requirements</small>
                </div>

                <div class="form-group">
                    <label for="emergency-contact">Emergency Contact (Optional)</label>
                    <input type="text" id="emergency-contact" name="emergency-contact" placeholder="Name and phone number">
                    <small>In case we need to reach someone during your game</small>
                </div>
            </div>

            <!-- Submit -->
            <div class="submit-section">
                <!-- Error Messages Container -->
                <div id="form-errors" class="form-errors" style="display: none;"></div>
                
                <button type="submit" class="btn-primary btn-sparkle" id="submit-booking-btn">
                    üìÖ Confirm Booking
                </button>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #666; text-align: center;">
                    By submitting this form, you agree to our <a href="privacy-policy.html" target="_blank" style="color: var(--accent-color);">Privacy Policy</a> and terms and conditions.
                </p>
                <p style="margin-top: 10px; font-size: 0.75rem; color: #999; line-height: 1.6; text-align: center; max-width: 600px; margin: 10px auto 0;">
                    <strong>Safety Notice:</strong> This game is designed to be played in a safe environment. Please play responsibly, be aware of your surroundings, follow all local laws and regulations, and exercise caution when navigating to locations. We are not responsible for any accidents, injuries, losses, or damages that may occur during gameplay. Participants play at their own risk.
                </p>
            </div>
        </form>

        <!-- Success Message -->
        <div id="booking-success" class="booking-success">
            <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
            <h2>Booking Confirmed!</h2>
            <p>Thank you for booking your adventure!</p>
            <p>We've sent a confirmation email to <strong id="confirmation-email"></strong></p>
            <p>You'll receive payment instructions shortly.</p>
            <div id="game-link" style="margin-top: 20px;"></div>
            <!--<p style="margin-top: 30px;">
                <a href="index.html" class="btn-primary btn-sparkle" style="text-decoration: none; display: inline-block;">
                    Return to Game
                </a>
            </p> -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="database.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS with your public key
        // EmailJS will be initialized in the sendGameLinkEmail function to ensure it uses the correct key
    </script>
    
    <script>
        // Wrap in IIFE to avoid variable conflicts with database.js
        (function() {
            'use strict';
            
            // Use localDb to avoid conflict with database.js which also declares 'db'
            let localDb = null;
            let isInitialized = false;

        // Initialize Firebase
        function initializeFirebase() {
            if (isInitialized) return true;
            
            if (typeof firebase === 'undefined' || typeof firebaseConfig === 'undefined') {
                console.error('Firebase not configured');
                return false;
            }

            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                localDb = firebase.firestore();
                isInitialized = true;
                return true;
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                return false;
            }
        }

        // selectPayment is defined at the end of the script (outside IIFE) for global access

        // Generate time slots (15-minute intervals from 09:00 to 19:00 UK time)
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 9; hour <= 19; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(timeString);
                }
            }
            return slots;
        }

        // Load available hours based on selected date and existing bookings
        async function loadAvailableTimeSlots(selectedDate) {
            if (!selectedDate) {
                // Reset hour dropdown
                const hourSelect = document.getElementById('time-hour');
                if (hourSelect) {
                    hourSelect.innerHTML = '<option value="">Hour</option>';
                }
                return;
            }

            const hourSelect = document.getElementById('time-hour');
            const minuteSelect = document.getElementById('time-minute');
            const allSlots = generateTimeSlots();
            
            // Generate available hours (9-19)
            const availableHours = [];
            for (let hour = 9; hour <= 19; hour++) {
                availableHours.push(hour.toString().padStart(2, '0'));
            }
            
            // Always show hours initially, even if database not ready
            // Database check will filter out taken slots if available
            // Get db reference if not set (use localDb to avoid conflict)
            if (!localDb && firebase && firebase.firestore) {
                localDb = firebase.firestore();
                isInitialized = true;
            }
            
            if (!localDb || !isInitialized) {
                console.log('Database not ready, showing all hours');
                if (hourSelect) {
                    hourSelect.innerHTML = '<option value="">Hour</option>';
                    availableHours.forEach(hour => {
                        const option = document.createElement('option');
                        option.value = hour;
                        option.textContent = hour;
                        hourSelect.appendChild(option);
                    });
                    hourSelect.disabled = false;
                }
                // Try to reload with database filtering once db is ready
                setTimeout(() => {
                    if (firebase && firebase.firestore && !localDb) {
                        localDb = firebase.firestore();
                        isInitialized = true;
                    }
                    if (localDb && isInitialized) {
                        loadAvailableTimeSlots(selectedDate);
                    }
                }, 100);
                return;
            }

            try {
                // Get db reference (use localDb to avoid conflict with database.js)
                const dbRef = localDb || (firebase && firebase.firestore ? firebase.firestore() : null);
                if (!dbRef) {
                    // Fallback: show all hours if db not available
                    if (hourSelect) {
                        hourSelect.innerHTML = '<option value="">Hour</option>';
                        availableHours.forEach(hour => {
                            const option = document.createElement('option');
                            option.value = hour;
                            option.textContent = hour;
                            hourSelect.appendChild(option);
                        });
                    }
                    return;
                }
                
                // Get all bookings for the selected date
                const snapshot = await dbRef.collection('bookings')
                    .where('date', '==', selectedDate)
                    .where('status', 'in', ['pending', 'confirmed'])
                    .get();

                const takenSlots = new Set();
                snapshot.forEach(doc => {
                    const booking = doc.data();
                    if (booking.time) {
                        // Normalize time format (ensure HH:MM format with leading zeros)
                        const time = booking.time.trim();
                        // Convert "9:00" to "09:00" if needed
                        const parts = time.split(':');
                        if (parts.length === 2) {
                            const normalizedTime = `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
                            takenSlots.add(normalizedTime);
                            console.log('Found booked slot:', normalizedTime);
                        } else {
                            takenSlots.add(time);
                        }
                    }
                });
                console.log('Total taken slots for', selectedDate, ':', Array.from(takenSlots));

                // Clear hour dropdown
                if (hourSelect) {
                    hourSelect.innerHTML = '<option value="">Hour</option>';
                }

                // Check current date and time to filter out past slots
                const now = new Date();
                const today = now.toISOString().split('T')[0]; // YYYY-MM-DD format
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const isToday = selectedDate === today;
                
                // Check which hours have available slots
                const hoursWithAvailability = new Set();
                availableHours.forEach(hour => {
                    const minutes = ['00', '15', '30', '45'];
                    minutes.forEach(minute => {
                        const slot = `${hour}:${minute}`;
                        
                        // Skip if slot is taken
                        if (takenSlots.has(slot)) {
                            return;
                        }
                        
                        // If today, filter out past time slots
                        if (isToday) {
                            const slotHour = parseInt(hour, 10);
                            const slotMinute = parseInt(minute, 10);
                            
                            // Skip if slot time has passed
                            if (slotHour < currentHour || (slotHour === currentHour && slotMinute < currentMinute)) {
                                return;
                            }
                        }
                        
                        // Slot is available
                        hoursWithAvailability.add(hour);
                    });
                });

                // Add available hours
                if (hourSelect) {
                    availableHours.forEach(hour => {
                        if (hoursWithAvailability.has(hour)) {
                            const option = document.createElement('option');
                            option.value = hour;
                            option.textContent = hour;
                            hourSelect.appendChild(option);
                        }
                    });

                    if (hoursWithAvailability.size === 0) {
                        hourSelect.innerHTML = '<option value="">No slots available</option>';
                        hourSelect.disabled = true;
                        if (minuteSelect) minuteSelect.disabled = true;
                    } else {
                        hourSelect.disabled = false;
                        if (minuteSelect) minuteSelect.disabled = false;
                    }
                }
            } catch (error) {
                console.error('Error loading time slots:', error);
                // On error, show all hours
                if (hourSelect) {
                    hourSelect.innerHTML = '<option value="">Hour</option>';
                    availableHours.forEach(hour => {
                        const option = document.createElement('option');
                        option.value = hour;
                        option.textContent = hour;
                        hourSelect.appendChild(option);
                    });
                }
            }
        }

        // Load available minutes based on selected hour and date
        async function loadAvailableMinutes(selectedHour) {
            const dateInput = document.getElementById('date');
            const selectedDate = dateInput.value;
            const minuteSelect = document.getElementById('time-minute');
            
            if (!selectedDate || !selectedHour || !minuteSelect) {
                if (minuteSelect) {
                    minuteSelect.innerHTML = '<option value="">Minute</option><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>';
                }
                return;
            }

            const allMinutes = ['00', '15', '30', '45'];
            
            // Get taken slots from database
            let takenSlots = new Set();
            const dbRef = localDb || (firebase && firebase.firestore ? firebase.firestore() : null);
            if (dbRef && isInitialized) {
                try {
                    const snapshot = await dbRef.collection('bookings')
                        .where('date', '==', selectedDate)
                        .where('status', 'in', ['pending', 'confirmed'])
                        .get();

                    snapshot.forEach(doc => {
                        const booking = doc.data();
                        if (booking.time) {
                            // Normalize time format (ensure HH:MM format with leading zeros)
                            const time = booking.time.trim();
                            const parts = time.split(':');
                            if (parts.length === 2) {
                                const normalizedTime = `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
                                takenSlots.add(normalizedTime);
                            } else {
                                takenSlots.add(time);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading minutes:', error);
                }
            }

            // Clear minute dropdown
            minuteSelect.innerHTML = '<option value="">Minute</option>';

            // Check current date and time to filter out past slots
            const now = new Date();
            const today = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const isToday = selectedDate === today;
            const selectedHourInt = parseInt(selectedHour, 10);
            
            // Add available minutes for the selected hour
            allMinutes.forEach(minute => {
                const slot = `${selectedHour}:${minute}`;
                
                // Skip if slot is taken
                if (takenSlots.has(slot)) {
                    return;
                }
                
                // If today, filter out past time slots
                if (isToday) {
                    const slotMinute = parseInt(minute, 10);
                    
                    // Skip if slot time has passed
                    if (selectedHourInt < currentHour || (selectedHourInt === currentHour && slotMinute < currentMinute)) {
                        return;
                    }
                }
                
                // Slot is available
                const option = document.createElement('option');
                option.value = minute;
                option.textContent = minute;
                minuteSelect.appendChild(option);
            });

            if (minuteSelect.options.length === 1) {
                minuteSelect.innerHTML = '<option value="">No slots available</option>';
                minuteSelect.disabled = true;
            } else {
                minuteSelect.disabled = false;
            }
        }

        // Update hidden time field when hour or minute changes
        function updateTimeField() {
            const hourSelect = document.getElementById('time-hour');
            const minuteSelect = document.getElementById('time-minute');
            const timeHidden = document.getElementById('time');
            
            if (hourSelect && minuteSelect && timeHidden) {
                if (hourSelect.value && minuteSelect.value) {
                    timeHidden.value = `${hourSelect.value}:${minuteSelect.value}`;
                } else {
                    timeHidden.value = '';
                }
            }
        }

        // Set minimum date to today
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            const hourSelect = document.getElementById('time-hour');
            const minuteSelect = document.getElementById('time-minute');
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);
            
            // Initialize Firebase - ensure both are initialized
            initializeFirebase();
            
            // Also initialize DatabaseService if available
            if (typeof window.DatabaseService !== 'undefined') {
                window.DatabaseService.initializeFirebase();
            }
            
            // ALWAYS populate hour dropdown immediately on page load
            // hourSelect is already declared above, so just use it
            if (hourSelect) {
                console.log('Populating hour dropdown on page load...');
                const availableHours = [];
                for (let hour = 9; hour <= 19; hour++) {
                    availableHours.push(hour.toString().padStart(2, '0'));
                }
                hourSelect.innerHTML = '<option value="">Hour</option>';
                availableHours.forEach(hour => {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = hour;
                    hourSelect.appendChild(option);
                });
                hourSelect.disabled = false;
                console.log('Hour dropdown populated with', availableHours.length, 'hours');
            }
            
            // Load hours with database filtering if date is selected
            if (dateInput.value) {
                loadAvailableTimeSlots(dateInput.value);
            }
            
            // Ensure db is set for future database operations
            const ensureDb = () => {
                if (!localDb && firebase && firebase.firestore) {
                    localDb = firebase.firestore();
                    isInitialized = true;
                    // Reload time slots with database filtering if date is selected
                    if (dateInput.value) {
                        loadAvailableTimeSlots(dateInput.value);
                    }
                } else if (!localDb || !isInitialized) {
                    // Retry if db not ready yet
                    setTimeout(ensureDb, 100);
                }
            };
            
            // Start checking after scripts load
            setTimeout(ensureDb, 300);

            // Load available hours when date changes
            dateInput.addEventListener('change', function() {
                loadAvailableTimeSlots(this.value);
                // Reset hour and minute selections
                hourSelect.value = '';
                minuteSelect.value = '';
                updateTimeField();
            });

            // Load available minutes when hour changes
            hourSelect.addEventListener('change', async function() {
                // Clear minute selection when hour changes
                minuteSelect.value = '';
                // Load available minutes for selected hour
                if (this.value) {
                    await loadAvailableMinutes(this.value);
                } else {
                    minuteSelect.innerHTML = '<option value="">Minute</option>';
                }
                updateTimeField();
            });

            minuteSelect.addEventListener('change', function() {
                updateTimeField();
            });

            // Initial load of time slots (for today)
            if (dateInput.value) {
                loadAvailableTimeSlots(dateInput.value);
            }
        });

        // Show form errors in centralized location
        function showFormErrors(errors) {
            const errorContainer = document.getElementById('form-errors');
            if (!errorContainer) return;
            
            if (errors.length === 0) {
                errorContainer.style.display = 'none';
                errorContainer.innerHTML = '';
                return;
            }
            
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <strong style="display: block; margin-bottom: 10px;">‚ö†Ô∏è Please fix the following errors:</strong>
                <ul>
                    ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
            
            // Scroll to error container
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Handle form submission
        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous errors and red highlighting
            document.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('error');
            });
            
            // Reset all field styles
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.style.borderColor = '';
                field.style.borderWidth = '';
                field.style.backgroundColor = '';
            });
            
            // Reset payment option styles
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.style.borderColor = '';
                opt.style.borderWidth = '';
                opt.style.backgroundColor = '';
            });
            
            showFormErrors([]);
            
            // Get form data
            const timeHour = document.getElementById('time-hour').value;
            const timeMinute = document.getElementById('time-minute').value;
            const timeValue = timeHour && timeMinute ? `${timeHour}:${timeMinute}` : '';
            
            const formData = {
                email: document.getElementById('email').value.trim(),
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                date: document.getElementById('date').value,
                time: timeValue,
                players: document.getElementById('players').value,
                messageFrom: document.getElementById('message-from').value.trim(),
                personalMessage: document.getElementById('personal-message').value.trim(),
                paymentMethod: document.querySelector('input[name="payment"]:checked')?.value,
                referral: document.getElementById('referral').value,
                specialRequests: document.getElementById('special-requests').value.trim(),
                emergencyContact: document.getElementById('emergency-contact').value.trim(),
                submittedAt: new Date().toISOString(),
                status: 'pending'
            };
            
            // Validation with field highlighting and scrolling
            let isValid = true;
            const errors = [];
            let firstErrorField = null;
            
            // Helper to highlight field in red and track first error
            function markFieldError(fieldId, errorMessage) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.style.borderColor = '#e94560';
                    field.style.borderWidth = '2px';
                    field.style.backgroundColor = 'rgba(233, 69, 96, 0.05)';
                    if (!firstErrorField) {
                        firstErrorField = field;
                    }
                }
                showError(fieldId, errorMessage);
            }
            
            if (!formData.email || !formData.email.includes('@')) {
                markFieldError('email', 'Please enter a valid email address');
                errors.push('Your email address is required');
                isValid = false;
            }
            
            if (!formData.name || formData.name.length < 2) {
                markFieldError('name', 'Please enter your full name');
                errors.push('Full name is required (at least 2 characters)');
                isValid = false;
            }
            
            if (!formData.phone || formData.phone.length < 5) {
                markFieldError('phone', 'Please enter a valid contact number');
                errors.push('Contact number is required');
                isValid = false;
            }
            
            if (!formData.date) {
                markFieldError('date', 'Please select a date');
                errors.push('Please select a date for your booking');
                isValid = false;
            }
            
            if (!formData.time || !timeHour || !timeMinute) {
                // Highlight both hour and minute fields
                const hourField = document.getElementById('time-hour');
                const minuteField = document.getElementById('time-minute');
                if (hourField) {
                    hourField.style.borderColor = '#e94560';
                    hourField.style.borderWidth = '2px';
                    hourField.style.backgroundColor = 'rgba(233, 69, 96, 0.05)';
                    if (!firstErrorField) firstErrorField = hourField;
                }
                if (minuteField) {
                    minuteField.style.borderColor = '#e94560';
                    minuteField.style.borderWidth = '2px';
                    minuteField.style.backgroundColor = 'rgba(233, 69, 96, 0.05)';
                    if (!firstErrorField) firstErrorField = minuteField;
                }
                showError('time', 'Please select both hour and minute');
                errors.push('Please select both hour and minute for your booking time');
                isValid = false;
            }
            
            if (!formData.players || parseInt(formData.players) < 1) {
                markFieldError('players', 'Please enter a valid number of players (minimum 1)');
                errors.push('Please enter the number of players (minimum 1)');
                isValid = false;
            }
            
            // Personal message is now optional, no validation needed
            
            if (!formData.paymentMethod) {
                // Highlight payment options
                const paymentOptions = document.querySelectorAll('.payment-option');
                paymentOptions.forEach(opt => {
                    opt.style.borderColor = '#e94560';
                    opt.style.borderWidth = '2px';
                    opt.style.backgroundColor = 'rgba(233, 69, 96, 0.05)';
                    if (!firstErrorField) firstErrorField = opt;
                });
                errors.push('Please select a payment method');
                isValid = false;
            }
            
            if (!formData.referral) {
                markFieldError('referral', 'Please tell us how you found us');
                errors.push('Please tell us how you found us');
                isValid = false;
            }
            
            if (!isValid) {
                console.log('Validation failed with', errors.length, 'errors:', errors);
                console.log('First error field:', firstErrorField);
                showFormErrors(errors);
                
                // Scroll to first error field
                if (firstErrorField) {
                    console.log('Scrolling to first error field:', firstErrorField.id || firstErrorField.className);
                    // For time fields, scroll to the time container
                    if (firstErrorField.id === 'time-hour' || firstErrorField.id === 'time-minute') {
                        const timeContainer = document.getElementById('time-hour').closest('.form-group');
                        if (timeContainer) {
                            timeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    // Focus the field if it's an input
                    if (firstErrorField.tagName === 'INPUT' || firstErrorField.tagName === 'SELECT' || firstErrorField.tagName === 'TEXTAREA') {
                        setTimeout(() => {
                            firstErrorField.focus();
                            console.log('Focused on error field');
                        }, 300);
                    }
                } else {
                    // Fallback: scroll to error container
                    const errorContainer = document.getElementById('form-errors');
                    if (errorContainer) {
                        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                return;
            }
            
            console.log('Validation passed');
            
            // Disable submit button
            const submitBtn = document.getElementById('submit-booking-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                // Save to Firebase
                // Get db reference (use localDb to avoid conflict with database.js)
                if (!localDb || !isInitialized) {
                    if (!initializeFirebase()) {
                        throw new Error('Database not available');
                    }
                }
                
                const dbRef = localDb || (firebase && firebase.firestore ? firebase.firestore() : null);
                if (!dbRef) {
                    throw new Error('Database not available');
                }
                
                // Add booking to Firestore and get the document reference
                const bookingRef = await dbRef.collection('bookings').add(formData);
                const bookingId = bookingRef.id;
                
                // Create game session linked to this booking
                if (window.DatabaseService && window.DatabaseService.isInitialized()) {
                    try {
                        const sessionId = await window.DatabaseService.createGameSessionFromBooking(bookingId, formData);
                        if (sessionId) {
                            console.log('Game session created:', sessionId);
                            const gameLink = `${window.location.origin}${window.location.pathname.replace('booking.html', 'index.html')}?bookingId=${bookingId}`;
                            // Store game link in booking document for easy access
                            await dbRef.collection('bookings').doc(bookingId).update({
                                gameSessionId: sessionId,
                                gameLink: gameLink,
                                updatedAt: firebase.firestore.Timestamp.now()
                            });
                            
                            // Send email to user with game link
                            try {
                                await sendGameLinkEmail(formData.email, gameLink, formData);
                            } catch (emailError) {
                                console.error('Error sending email:', emailError);
                                // Don't fail the booking if email fails
                            }
                        }
                    } catch (gameError) {
                        console.error('Error creating game session:', gameError);
                        // Don't fail the booking if game session creation fails
                    }
                }
                
                // Show success message with game link
                document.getElementById('booking-form').style.display = 'none';
                document.getElementById('booking-success').classList.add('show');
                document.getElementById('confirmation-email').textContent = formData.email;
                
                // Display game link if available
                const gameLinkElement = document.getElementById('game-link');
                if (gameLinkElement) {
                    const gameLink = `${window.location.origin}${window.location.pathname.replace('booking.html', 'index.html')}?bookingId=${bookingId}`;
                    gameLinkElement.innerHTML = `
                        <p style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea;">
                            <strong>üéÆ Your Game Link:</strong><br>
                            <a href="${gameLink}" target="_blank" style="color: #667eea; word-break: break-all;">${gameLink}</a><br>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Save this link! You'll need it to play the game. The game will be available 15 minutes before your booking time.
                            </small>
                        </p>
                    `;
                }
                
            } catch (error) {
                console.error('Error saving booking:', error);
                alert('There was an error processing your booking. Please try again or contact us directly.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üìÖ Confirm Booking';
            }
        });

        // Show error message
        function showError(fieldId, message) {
            const formGroup = document.getElementById(fieldId).closest('.form-group');
            formGroup.classList.add('error');
            const errorDiv = formGroup.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
            }
        }
        })(); // End IIFE
        
        // Function to send game link email to recipient (outside IIFE)
        async function sendGameLinkEmail(recipientEmail, gameLink, formData) {
            try {
                // Simple email sending using EmailJS
                // You'll need to set up EmailJS account and configure:
                // 1. Create an EmailJS account at https://www.emailjs.com
                // 2. Add your email service (Gmail, Outlook, etc.) - use meghana.shettigar@gmail.com
                // 3. Create an email template
                // 4. Get your service ID, template ID, and public key
                // 5. Replace the placeholders below
                
                const serviceId = 'service_gmail_form'; // Replace with your EmailJS service ID
                const templateId = 'template_xdcp7so'; // Replace with your EmailJS template ID
                const publicKey = 'HN28jUjYkvwhLWLBk'; // Replace with your EmailJS public key
                
                // Initialize EmailJS (only if not already initialized)
                if (typeof emailjs !== 'undefined' && serviceId !== 'YOUR_EMAILJS_SERVICE_ID') {
                    // Initialize EmailJS only once - check if already initialized
                    try {
                        emailjs.init(publicKey);
                    } catch (initError) {
                        // If already initialized, that's fine - continue
                        if (!initError.message || !initError.message.includes('already been initialized')) {
                            console.warn('EmailJS initialization note:', initError);
                        }
                    }
                    
                    // Build email content - match the template structure
                    // The template uses {{game_link}} and {{from_name}} in the body
                    // We need to send only the variables that exist in the template
                    const fromName = formData.messageFrom || formData.name || 'Treasure Hunt Team';
                    const numPlayers = parseInt(formData.players) || 1;
                    
                    // Build forwarding instructions text
                    const forwardingInstructions = `\n\nüìß IMPORTANT: Please forward this email to everyone who will be playing the game.\n\nüì± Number of Screens: You can open this game link on up to ${numPlayers} screen(s) based on the number of participants you booked. If you try to open the game on more screens than the number of participants, you may experience glitches or errors.\n\nüí° Tip: Each player should use the same game link, but only ${numPlayers} screen(s) can be active at the same time.`;
                    
                    // Build personal message section if provided
                    let personalMessageSection = '';
                    if (formData.personalMessage && formData.personalMessage.trim()) {
                        personalMessageSection = `\n\n---\n\nA special message from ${fromName}:\n\n${formData.personalMessage}`;
                    }
                    
                    // Template parameters - only include variables that exist in your EmailJS template
                    // Based on your template, it has: {{subject}}, {{game_link}}, {{from_name}}, {{to_email}}, {{from_email}}
                    // NOTE: To include personal message and forwarding instructions, add {{personal_message}} and {{forwarding_instructions}} to your EmailJS template
                    const templateParams = {
                        to_email: recipientEmail,
                        from_email: 'meghana.shettigar@gmail.com',
                        from_name: fromName,
                        subject: 'Your Treasure Hunt Game Link!',
                        game_link: gameLink,
                        forwarding_instructions: forwardingInstructions,
                        num_players: numPlayers.toString()
                    };
                    
                    // Add personal_message if template supports it (uncomment after adding {{personal_message}} to template)
                    // if (personalMessageSection) {
                    //     templateParams.personal_message = personalMessageSection;
                    // }
                    
                    // Log the parameters for debugging
                    console.log('Sending email with parameters:', templateParams);
                    
                    try {
                        const response = await emailjs.send(serviceId, templateId, templateParams);
                        console.log('Email sent successfully via EmailJS:', response);
                    } catch (emailError) {
                        console.error('EmailJS error details:', emailError);
                        // Log more details if available
                        if (emailError.text) {
                            console.error('EmailJS error text:', emailError.text);
                        }
                        throw emailError; // Re-throw to be caught by outer catch
                    }
                } else {
                    // Fallback: Log email details (for development/testing)
                    const numPlayers = parseInt(formData.players) || 1;
                    let emailBody = `Hi there!\n\nYou've been invited to play a treasure hunt game!\n\nClick this link to start playing: ${gameLink}\n\nThe game will be available 15 minutes before your scheduled time (${formData.date} at ${formData.time}).\n\nüìß IMPORTANT: Please forward this email to everyone who will be playing the game.\n\nüì± Number of Screens: You can open this game link on up to ${numPlayers} screen(s) based on the number of participants you booked. If you try to open the game on more screens than the number of participants, you may experience glitches or errors.\n\nüí° Tip: Each player should use the same game link, but only ${numPlayers} screen(s) can be active at the same time.\n\nHave fun and enjoy the adventure!\n\nBest regards,\n${formData.name || 'Treasure Hunt Team'}`;
                    
                    if (formData.personalMessage) {
                        const fromName = formData.messageFrom || formData.name || 'Someone special';
                        emailBody += `\n\n---\n\nA special message from ${fromName}:\n\n${formData.personalMessage}`;
                    }
                    
                    console.log('Email service not configured. Email would be sent:');
                    console.log('To:', recipientEmail);
                    console.log('From: meghana.shettigar@gmail.com');
                    console.log('Subject: Your Treasure Hunt Game Link');
                    console.log('Game Link:', gameLink);
                    console.log('Message:', emailBody);
                    
                    // For production, you'll need to configure EmailJS or use a backend service
                    console.warn('Email service not configured. Please set up EmailJS or use a backend email service.');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                // Don't throw - allow booking to complete even if email fails
                console.warn('Email sending failed, but booking was successful');
            }
        }
        
        // Make selectPayment globally accessible (outside IIFE scope)
        window.selectPayment = function(method) {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            const paymentInput = document.getElementById(`payment-${method}`);
            if (paymentInput) {
                paymentInput.checked = true;
                const paymentOption = paymentInput.closest('.payment-option');
                if (paymentOption) {
                    paymentOption.classList.add('selected');
                }
            }
        };
    </script>
</body>
</html>
