# Booking to Game Integration Guide

## Overview
This document explains how bookings are linked to game sessions and how the game access control system works.

## How BookingId Works

### 1. Booking Creation
When a player books a game slot:
- A booking document is created in Firestore `bookings` collection
- The **document ID** becomes the `bookingId` (automatically generated by Firestore)
- Example: `bookings/ABC123xyz` ‚Üí `bookingId = "ABC123xyz"`

### 2. Game Session Creation
When a booking is created:
- A game session is automatically created in `gameSessions` collection
- The session is linked to the booking via `bookingId`
- The booking document stores:
  - `gameSessionId`: The game session document ID
  - `gameLink`: The full URL to access the game

### 3. Game Link Format
```
https://yourdomain.com/index.html?bookingId=ABC123xyz
```

## Integration Flow

### Step 1: Player Books
1. Player fills out booking form on `booking.html`
2. Booking is saved to Firestore
3. **Automatically creates game session** via `createGameSessionFromBooking()`
4. Game link is generated and displayed to player
5. Game link is stored in booking document

### Step 2: Player Accesses Game
1. Player clicks game link (or admin sends link)
2. URL contains `?bookingId=ABC123xyz`
3. Game checks access via `canAccessGame(bookingId)`
4. Validates:
   - Booking time (15 minutes before booking time)
   - Game status (not completed/abandoned)
5. If valid: Game loads and starts
6. If invalid: Shows error message

### Step 3: Admin Management
- Admins can generate/resend game links from dashboard
- Click "üîó Link" button next to any booking
- Link is copied to clipboard automatically
- Can be shared with players via email/SMS

## Database Structure

### Bookings Collection
```javascript
{
  id: "ABC123xyz",  // This is the bookingId
  name: "John Doe",
  email: "john@example.com",
  date: "2025-01-15",
  time: "14:00",
  players: 2,
  gameSessionId: "session_1234567890_abc",
  gameLink: "https://domain.com/index.html?bookingId=ABC123xyz",
  status: "confirmed",
  // ... other booking fields
}
```

### Game Sessions Collection
```javascript
{
  sessionId: "session_1234567890_abc",
  bookingId: "ABC123xyz",  // Links to booking
  bookingDate: "2025-01-15",
  bookingTime: "14:00",
  gameStatus: "pending",  // pending, active, completed, abandoned
  playerType: "group",
  playerName: "John Doe",
  // ... game state fields
}
```

## Access Control Rules

### Time-Based Access
- ‚úÖ Game accessible: 15 minutes before booking time
- ‚ùå Game blocked: Before 15 minutes before booking time
- Message shown: "Game will be available X minute(s) before your booking time"

### Status-Based Access
- ‚úÖ **pending**: Can start game
- ‚úÖ **active**: Can resume game (if within 1 hour of last play)
- ‚ùå **completed**: Cannot replay (locked forever)
- ‚ùå **abandoned**: Can resume within 1 hour, then locked

### Abandonment Window
- If player leaves mid-game, status becomes "abandoned"
- Player has 1 hour to resume
- After 1 hour, game is permanently locked
- Prevents players from replaying after going home

## Admin Functions

### Generate Game Link
1. Open admin dashboard
2. Find booking in "Upcoming Bookings" or "Completed Bookings"
3. Click "üîó Link" button
4. Link is copied to clipboard
5. Share with player via email/SMS

### What Happens When Link is Generated
- Checks if game session exists
- Creates session if it doesn't exist
- Generates game link with bookingId
- Copies link to clipboard
- Updates booking document with link

## Player Experience

### Individual Players
- One booking = One game session
- One device can access the game
- Game link sent after booking

### Group Players
- One booking = One game session (shared)
- Multiple devices can access same game
- All devices use same game link
- Progress is synchronized across devices

## Testing

### Test Booking Flow
1. Create a booking via `booking.html`
2. Check that game session is created
3. Copy game link from success message
4. Try accessing game before booking time (should be blocked)
5. Wait until 15 minutes before booking time
6. Access game (should work)
7. Complete game
8. Try accessing again (should be blocked - completed)

### Test Admin Functions
1. Open admin dashboard
2. Find a booking
3. Click "üîó Link" button
4. Verify link is copied
5. Verify link contains correct bookingId
6. Test link in new tab

## Troubleshooting

### Game Session Not Created
- Check browser console for errors
- Verify `database.js` is loaded
- Check Firebase initialization
- Verify booking was created successfully

### Link Not Working
- Verify bookingId in URL matches booking document ID
- Check game status (should be pending/active)
- Check booking time (should be within access window)
- Verify booking exists in Firestore

### Access Denied Errors
- Check booking date/time
- Verify game status
- Check if game was completed/abandoned
- Verify bookingId is correct

## Next Steps

1. **Email Integration**: Send game link automatically in booking confirmation email
2. **SMS Integration**: Send game link via SMS
3. **Reminder System**: Send reminder with game link before booking time
4. **Analytics**: Track game link usage and access patterns
